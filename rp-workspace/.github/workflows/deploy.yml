name: Deploy - Full Stack (API + Portal + Database)

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - production
      deploy_database:
        description: 'Deploy database'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8'

jobs:
  integrity-check:
    name: Pre-Deployment Integrity Check
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: requirements_db_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: |
          echo "üîç Running lint checks..."
          npm run lint:api || exit 1
          cd apps/portal && npm run lint || exit 1
          echo "‚úÖ Linting passed"

      - name: Run tests with coverage
        working-directory: apps/api
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_DATABASE: requirements_db_test
          DB_SYNCHRONIZE: true
          JWT_SECRET: test-jwt-secret-key-min-32-characters-long
          JWT_EXPIRES_IN: 1h
        run: |
          echo "üß™ Running tests..."
          npm run test:cov:check || exit 1
          echo "‚úÖ Tests passed"

      - name: Verify builds
        run: |
          echo "üèóÔ∏è Verifying builds..."
          npm run build:api || exit 1
          cd apps/portal && npm run build || exit 1
          echo "‚úÖ All builds successful"

  deploy-stack:
    name: Deploy Full Stack
    runs-on: ubuntu-latest
    needs: [integrity-check]
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        if: env.DOCKER_REGISTRY != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" != "" ]; then
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=development" >> $GITHUB_OUTPUT
          fi

      - name: Create environment file
        run: |
          cat > .env << EOF
          # Environment: ${{ steps.env.outputs.env }}
          NODE_ENV=${{ steps.env.outputs.env }}
          
          # Database Configuration
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_SYNCHRONIZE=${{ steps.env.outputs.env == 'development' && 'true' || 'false' }}
          DB_LOGGING=${{ steps.env.outputs.env == 'development' && 'true' || 'false' }}
          
          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN || '1d' }}
          
          # CORS Configuration
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN || 'http://localhost:4200' }}
          
          # API Configuration
          API_PORT=${{ secrets.API_PORT || '3000' }}
          
          # Portal Configuration
          PORTAL_PORT=${{ secrets.PORTAL_PORT || '4200' }}
          NEXT_PUBLIC_API_URL=${{ steps.env.outputs.env == 'production' && secrets.NEXT_PUBLIC_API_URL_PRODUCTION || secrets.NEXT_PUBLIC_API_URL_DEV }}
          
          # Monitoring
          ENABLE_MONITORING=true
          METRICS_RETENTION_MS=3600000
          LOG_LEVEL=${{ steps.env.outputs.env == 'production' && 'info' || 'debug' }}
          EOF

      - name: Build Docker images
        run: |
          echo "üê≥ Building Docker images..."
          
          # Build API image
          docker build -f apps/api/Dockerfile \
            -t ${{ secrets.DOCKER_REGISTRY || 'local' }}/api:${{ github.sha }} \
            -t ${{ secrets.DOCKER_REGISTRY || 'local' }}/api:latest \
            .
          
          # Build Portal image
          docker build -f apps/portal/Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=${{ steps.env.outputs.env == 'production' && secrets.NEXT_PUBLIC_API_URL_PRODUCTION || secrets.NEXT_PUBLIC_API_URL_DEV }} \
            -t ${{ secrets.DOCKER_REGISTRY || 'local' }}/portal:${{ github.sha }} \
            -t ${{ secrets.DOCKER_REGISTRY || 'local' }}/portal:latest \
            .
          
          echo "‚úÖ Images built successfully"

      - name: Push Docker images
        if: secrets.DOCKER_REGISTRY != ''
        run: |
          echo "üì§ Pushing Docker images..."
          docker push ${{ secrets.DOCKER_REGISTRY }}/api:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/api:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/portal:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/portal:latest
          echo "‚úÖ Images pushed successfully"

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Deploying full stack..."
          
          # Pull latest images if using registry
          if [ "${{ secrets.DOCKER_REGISTRY }}" != "" ]; then
            docker-compose pull || true
          fi
          
          # Start services
          docker-compose up -d
          
          echo "‚úÖ Stack deployed successfully"

      - name: Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          
          # Check API health
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/v1/health/liveness > /dev/null 2>&1; then
              echo "‚úÖ API is healthy"
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done
          
          # Check Portal health
          for i in {1..30}; do
            if curl -f http://localhost:4200 > /dev/null 2>&1; then
              echo "‚úÖ Portal is healthy"
              break
            fi
            echo "Waiting for Portal... ($i/30)"
            sleep 2
          done
          
          # Check Database health
          if [ "${{ github.event.inputs.deploy_database }}" != "false" ]; then
            docker-compose exec -T postgres pg_isready -U ${{ secrets.DB_USERNAME }} || echo "‚ö†Ô∏è Database check skipped"
          fi

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          docker-compose exec -T api npm run migration:run || echo "‚ö†Ô∏è Migrations already applied or skipped"
          echo "‚úÖ Migrations completed"

      - name: Health check summary
        run: |
          echo "## üè• Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # API Health
          if curl -f http://localhost:3000/api/v1/health/liveness > /dev/null 2>&1; then
            echo "‚úÖ API: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå API: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Portal Health
          if curl -f http://localhost:4200 > /dev/null 2>&1; then
            echo "‚úÖ Portal: Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Portal: Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Database Health
          if [ "${{ github.event.inputs.deploy_database }}" != "false" ]; then
            if docker-compose exec -T postgres pg_isready -U ${{ secrets.DB_USERNAME }} > /dev/null 2>&1; then
              echo "‚úÖ Database: Healthy" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Database: Unhealthy" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚è≠Ô∏è Database: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Show service status
        run: |
          echo "üìä Service Status:"
          docker-compose ps

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-stack]
    if: always()
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy-stack.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "Environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}"
            echo "Commit: ${{ github.sha }}"
            # Agregar notificaciones aqu√≠ (Slack, Teams, Email, etc.)
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi

