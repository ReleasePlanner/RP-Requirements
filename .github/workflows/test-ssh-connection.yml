name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH Connection to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH tools
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass || true

      - name: Debug Secrets
        run: |
          echo "üîç Checking secrets..."
          echo "VPS_HOST configured: ${{ secrets.VPS_HOST != '' }}"
          echo "VPS_USER configured: ${{ secrets.VPS_USER != '' }}"
          echo "VPS_SSH_KEY configured: ${{ secrets.VPS_SSH_KEY != '' }}"
          echo "VPS_SSH_PASSWORD configured: ${{ secrets.VPS_SSH_PASSWORD != '' }}"
          
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå VPS_HOST secret is not configured"
            exit 1
          fi
          
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ö†Ô∏è VPS_USER not configured, will use 'root'"
          fi

      - name: Check SSH credentials
        id: check-ssh
        run: |
          if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "has_ssh_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_ssh_key=false" >> $GITHUB_OUTPUT
          fi
          if [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "has_ssh_password=true" >> $GITHUB_OUTPUT
          else
            echo "has_ssh_password=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH Key (only if no password)
        if: steps.check-ssh.outputs.has_ssh_key == 'true' && steps.check-ssh.outputs.has_ssh_password == 'false'
        continue-on-error: true
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Test SSH Connection
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üîê Testing SSH connection to $VPS_USER@$VPS_HOST..."
          
          # Priorizar contrase√±a si est√° configurada (m√°s confiable cuando est√° configurada)
          if [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "üîë Using SSH password authentication..."
            
            # Guardar contrase√±a en variable de entorno de forma segura
            export SSHPASS='${{ secrets.VPS_SSH_PASSWORD }}'
            
            # Debugging (sin mostrar la contrase√±a)
            PASSWORD_LENGTH=$(echo -n "$SSHPASS" | wc -c)
            echo "üîç Password length: $PASSWORD_LENGTH characters"
            echo "üîç User: $VPS_USER"
            echo "üîç Host: $VPS_HOST"
            
            # Deshabilitar agente SSH para evitar intentar usar claves
            unset SSH_AUTH_SOCK
            unset SSH_AGENT_PID
            export SSH_AUTH_SOCK=""
            export SSH_AGENT_PID=""
            
            # Eliminar cualquier clave del agente si existe
            ssh-add -D 2>/dev/null || true
            
            # Eliminar TODAS las claves posibles del sistema
            rm -f ~/.ssh/id_* 2>/dev/null || true
            rm -f ~/.ssh/known_hosts 2>/dev/null || true
            
            # Usar sshpass con variable de entorno (m√°s seguro para caracteres especiales)
            sshpass -e ssh -v \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              -o PreferredAuthentications=password \
              -o PubkeyAuthentication=no \
              -o PasswordAuthentication=yes \
              -o BatchMode=yes \
              -o NumberOfPasswordPrompts=1 \
              -o IdentitiesOnly=yes \
              -o IdentityFile=/dev/null \
              -o KbdInteractiveAuthentication=no \
              -o ChallengeResponseAuthentication=no \
              -o GSSAPIAuthentication=no \
              -o HostbasedAuthentication=no \
              $VPS_USER@$VPS_HOST \
              "echo '‚úÖ SSH connection successful!' && uname -a && docker --version 2>/dev/null || echo '‚ö†Ô∏è Docker not installed'" 2>&1 | tee /tmp/ssh-test.log || {
              echo "‚ùå SSH connection test failed with password"
              echo "üìã Last 20 lines of SSH debug output:"
              tail -20 /tmp/ssh-test.log || true
              echo ""
              echo "üîç Troubleshooting:"
              echo "   1. Verify VPS_SSH_PASSWORD is EXACTLY the same as when you manually connect"
              echo "   2. Test manually: ssh $VPS_USER@$VPS_HOST"
              echo "   3. Check for hidden characters or spaces in the password"
              echo "   4. Verify VPS_USER is correct (usually 'root')"
              echo "   5. Verify the server allows password authentication"
              exit 1
            }
          elif [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "üîë Using SSH key authentication..."
            echo "üìã Verifying SSH key format..."
            if ! ssh-add -l 2>/dev/null | grep -q "The agent has no identities"; then
              echo "‚úÖ SSH key loaded in agent"
              ssh-add -l
            else
              echo "‚ö†Ô∏è SSH key not loaded in agent"
            fi
            
            ssh -v -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=10 \
                $VPS_USER@$VPS_HOST \
                "echo '‚úÖ SSH connection successful!' && uname -a && docker --version 2>/dev/null || echo '‚ö†Ô∏è Docker not installed'" || {
              echo "‚ùå SSH connection test failed with SSH key"
              echo "üí° Troubleshooting steps:"
              echo "   1. Verify VPS_SSH_KEY in GitHub Secrets includes BEGIN and END lines"
              echo "   2. Verify the public key is in ~/.ssh/authorized_keys on the VPS"
              echo "   3. Check file permissions: chmod 600 ~/.ssh/authorized_keys"
              echo "   4. Verify VPS_USER is correct (usually 'root')"
              echo "   5. Try using VPS_SSH_PASSWORD instead for testing"
              exit 1
            }
          else
            echo "‚ùå No SSH credentials provided"
            echo "üí° Please configure either VPS_SSH_KEY or VPS_SSH_PASSWORD in GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ SSH connection test successful"

      - name: Test Docker Installation
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üê≥ Testing Docker installation..."
          
          # Priorizar contrase√±a si est√° configurada
          if [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            export SSHPASS='${{ secrets.VPS_SSH_PASSWORD }}'
            unset SSH_AUTH_SOCK
            unset SSH_AGENT_PID
            export SSH_AUTH_SOCK=""
            export SSH_AGENT_PID=""
            
            sshpass -e ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o PreferredAuthentications=password \
                -o PubkeyAuthentication=no \
                -o PasswordAuthentication=yes \
                -o BatchMode=yes \
                -o NumberOfPasswordPrompts=1 \
                -o IdentitiesOnly=yes \
                -o IdentityFile=/dev/null \
                $VPS_USER@$VPS_HOST \
                "docker --version && docker-compose --version || echo '‚ö†Ô∏è Docker Compose not installed'"
          elif [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "docker --version && docker-compose --version || echo '‚ö†Ô∏è Docker Compose not installed'"
          fi

      - name: Test Directory Permissions
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üìÅ Testing directory permissions..."
          
          # Priorizar contrase√±a si est√° configurada
          if [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            export SSHPASS='${{ secrets.VPS_SSH_PASSWORD }}'
            unset SSH_AUTH_SOCK
            unset SSH_AGENT_PID
            export SSH_AUTH_SOCK=""
            export SSH_AGENT_PID=""
            
            sshpass -e ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o PreferredAuthentications=password \
                -o PubkeyAuthentication=no \
                -o PasswordAuthentication=yes \
                -o BatchMode=yes \
                -o NumberOfPasswordPrompts=1 \
                -o IdentitiesOnly=yes \
                -o IdentityFile=/dev/null \
                $VPS_USER@$VPS_HOST \
                "mkdir -p /opt/modules/requirements-management && ls -la /opt/modules && echo '‚úÖ Directory accessible'"
          elif [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "mkdir -p /opt/modules/requirements-management && ls -la /opt/modules && echo '‚úÖ Directory accessible'"
          fi

