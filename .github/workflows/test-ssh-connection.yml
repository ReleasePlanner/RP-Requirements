name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH Connection to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH tools
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass || true

      - name: Debug Secrets
        run: |
          echo "üîç Checking secrets..."
          echo "VPS_HOST configured: ${{ secrets.VPS_HOST != '' }}"
          echo "VPS_USER configured: ${{ secrets.VPS_USER != '' }}"
          echo "VPS_SSH_KEY configured: ${{ secrets.VPS_SSH_KEY != '' }}"
          echo "VPS_SSH_PASSWORD configured: ${{ secrets.VPS_SSH_PASSWORD != '' }}"
          
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå VPS_HOST secret is not configured"
            exit 1
          fi
          
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ö†Ô∏è VPS_USER not configured, will use 'root'"
          fi

      - name: Test SSH with Key
        if: ${{ secrets.VPS_SSH_KEY != '' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Test SSH Connection
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üîê Testing SSH connection to $VPS_USER@$VPS_HOST..."
          
          if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "Using SSH key authentication..."
            ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=10 \
                -v \
                $VPS_USER@$VPS_HOST \
                "echo '‚úÖ SSH connection successful!' && uname -a && docker --version 2>/dev/null || echo '‚ö†Ô∏è Docker not installed'"
          elif [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "Using SSH password authentication..."
            sshpass -p '${{ secrets.VPS_SSH_PASSWORD }}' \
              ssh -o StrictHostKeyChecking=no \
                  -o UserKnownHostsFile=/dev/null \
                  -o ConnectTimeout=10 \
                  -v \
                  $VPS_USER@$VPS_HOST \
                  "echo '‚úÖ SSH connection successful!' && uname -a && docker --version 2>/dev/null || echo '‚ö†Ô∏è Docker not installed'"
          else
            echo "‚ùå No SSH credentials provided"
            echo "Please configure either VPS_SSH_KEY or VPS_SSH_PASSWORD in GitHub Secrets"
            exit 1
          fi

      - name: Test Docker Installation
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üê≥ Testing Docker installation..."
          
          if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "docker --version && docker-compose --version || echo '‚ö†Ô∏è Docker Compose not installed'"
          elif [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            sshpass -p '${{ secrets.VPS_SSH_PASSWORD }}' \
              ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "docker --version && docker-compose --version || echo '‚ö†Ô∏è Docker Compose not installed'"
          fi

      - name: Test Directory Permissions
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          echo "üìÅ Testing directory permissions..."
          
          if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "mkdir -p /opt/modules && ls -la /opt/modules && echo '‚úÖ Directory accessible'"
          elif [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            sshpass -p '${{ secrets.VPS_SSH_PASSWORD }}' \
              ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VPS_USER@$VPS_HOST \
              "mkdir -p /opt/modules && ls -la /opt/modules && echo '‚úÖ Directory accessible'"
          fi

