name: Verify All GitHub Secrets

on:
  workflow_dispatch:

jobs:
  verify-secrets:
    name: Verify All GitHub Secrets Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Verify All Required Secrets
        run: |
          echo "=========================================="
          echo "  üîê Verificaci√≥n de Todos los Secrets"
          echo "=========================================="
          echo ""
          
          # Contador de secrets configurados
          CONFIGURED=0
          MISSING=0
          TOTAL=0
          
          # Funci√≥n para verificar un secret
          check_secret() {
            local name=$1
            local description=$2
            local expected_length=$3
            local expected_start=$4
            local expected_end=$5
            
            TOTAL=$((TOTAL + 1))
            echo "üîç Verificando: $name"
            echo "   Descripci√≥n: $description"
            
            if [ -z "${{ secrets.$name }}" ]; then
              echo "   ‚ùå NO est√° configurado"
              MISSING=$((MISSING + 1))
              return 1
            else
              echo "   ‚úÖ Est√° configurado"
              
              # Obtener informaci√≥n sin mostrar el valor completo
              VALUE="${{ secrets.$name }}"
              LENGTH=$(echo -n "$VALUE" | wc -c)
              
              echo "   üìè Longitud: $LENGTH caracteres"
              
              if [ -n "$expected_length" ]; then
                if [ "$LENGTH" -eq "$expected_length" ]; then
                  echo "   ‚úÖ Longitud correcta (esperada: $expected_length)"
                else
                  echo "   ‚ö†Ô∏è Longitud incorrecta (esperada: $expected_length, actual: $LENGTH)"
                fi
              fi
              
              if [ -n "$expected_start" ]; then
                FIRST_CHAR=$(echo -n "$VALUE" | head -c 1)
                if [ "$FIRST_CHAR" == "$expected_start" ]; then
                  echo "   ‚úÖ Primer car√°cter correcto ($expected_start)"
                else
                  echo "   ‚ö†Ô∏è Primer car√°cter: '$FIRST_CHAR' (esperado: '$expected_start')"
                fi
              fi
              
              if [ -n "$expected_end" ]; then
                LAST_CHAR=$(echo -n "$VALUE" | tail -c 1)
                if [ "$LAST_CHAR" == "$expected_end" ]; then
                  echo "   ‚úÖ √öltimo car√°cter correcto ($expected_end)"
                else
                  echo "   ‚ö†Ô∏è √öltimo car√°cter: '$LAST_CHAR' (esperado: '$expected_end')"
                fi
              fi
              
              # Verificar espacios
              if echo "$VALUE" | grep -q '^ ' || echo "$VALUE" | grep -q ' $'; then
                echo "   ‚ö†Ô∏è ADVERTENCIA: Tiene espacios al inicio o final"
              else
                echo "   ‚úÖ Sin espacios extra"
              fi
              
              CONFIGURED=$((CONFIGURED + 1))
              return 0
            fi
            echo ""
          }
          
          # Verificar secrets requeridos
          echo "üìã SECRETS REQUERIDOS PARA DEPLOYMENT:"
          echo ""
          
          check_secret "VPS_HOST" "IP o hostname del servidor VPS" "" "" ""
          echo ""
          
          check_secret "VPS_USER" "Usuario SSH del servidor (generalmente 'root')" "" "" ""
          echo ""
          
          check_secret "VPS_SSH_PASSWORD" "Contrase√±a SSH del servidor" "13" "A" "6"
          echo ""
          
          # Verificar secrets opcionales
          echo "üìã SECRETS OPCIONALES:"
          echo ""
          
          check_secret "VPS_SSH_KEY" "Clave SSH privada (alternativa a contrase√±a)" "" "" ""
          echo ""
          
          # Resumen
          echo "=========================================="
          echo "  üìä RESUMEN"
          echo "=========================================="
          echo ""
          echo "Total de secrets verificados: $TOTAL"
          echo "‚úÖ Configurados: $CONFIGURED"
          echo "‚ùå Faltantes: $MISSING"
          echo ""
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ö†Ô∏è Faltan $MISSING secret(s) requerido(s)"
            echo ""
            echo "üí° Para configurar los secrets faltantes:"
            echo "   1. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Agrega cada secret faltante"
            exit 1
          else
            echo "‚úÖ Todos los secrets requeridos est√°n configurados"
            echo ""
            echo "üìã Valores esperados:"
            echo ""
            echo "   VPS_HOST:"
            echo "      Valor esperado: 72.60.63.240"
            echo "      Tipo: IP del servidor"
            echo ""
            echo "   VPS_USER:"
            echo "      Valor esperado: root"
            echo "      Tipo: Usuario SSH"
            echo ""
            echo "   VPS_SSH_PASSWORD:"
            echo "      Valor esperado: Aar-Beto-2026"
            echo "      Longitud esperada: 13 caracteres"
            echo "      Primer car√°cter: A"
            echo "      √öltimo car√°cter: 6"
            echo "      Tipo: Contrase√±a SSH"
            echo ""
            echo "   VPS_SSH_KEY (opcional):"
            echo "      Valor esperado: Clave SSH privada completa"
            echo "      Debe incluir: -----BEGIN ... KEY-----"
            echo "      Tipo: Clave SSH privada"
            echo ""
            echo "‚úÖ Si todos los valores coinciden, puedes proceder con el deployment"
          fi
          
          echo ""
          echo "=========================================="

      - name: Test SSH Connection with Secrets
        if: success()
        run: |
          echo "üß™ Probando conexi√≥n SSH con los secrets configurados..."
          echo ""
          
          # Instalar herramientas
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass
          
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER || 'root' }}"
          
          if [ -z "$VPS_HOST" ]; then
            echo "‚ùå VPS_HOST no est√° configurado"
            exit 1
          fi
          
          echo "üîç Configuraci√≥n:"
          echo "   Host: $VPS_HOST"
          echo "   User: $VPS_USER"
          echo ""
          
          # Deshabilitar agente SSH
          unset SSH_AUTH_SOCK
          unset SSH_AGENT_PID
          export SSH_AUTH_SOCK=""
          export SSH_AGENT_PID=""
          rm -f ~/.ssh/id_* 2>/dev/null || true
          rm -f ~/.ssh/known_hosts 2>/dev/null || true
          
          # Probar conexi√≥n
          if [ -n "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "üîë Usando autenticaci√≥n por contrase√±a..."
            if sshpass -p '${{ secrets.VPS_SSH_PASSWORD }}' ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o PreferredAuthentications=password \
                -o PubkeyAuthentication=no \
                -o PasswordAuthentication=yes \
                -o BatchMode=yes \
                -o IdentitiesOnly=yes \
                -o IdentityFile=/dev/null \
                "$VPS_USER@$VPS_HOST" \
                "echo '‚úÖ Conexi√≥n SSH exitosa' && hostname" 2>&1 | tail -5; then
              echo ""
              echo "‚úÖ ¬°La conexi√≥n SSH funciona correctamente!"
              echo ""
              echo "üéâ Todos los secrets est√°n configurados correctamente"
            else
              echo ""
              echo "‚ùå La conexi√≥n SSH fall√≥"
              echo ""
              echo "üí° Verifica:"
              echo "   1. VPS_SSH_PASSWORD es correcta"
              echo "   2. VPS_HOST es correcto"
              echo "   3. VPS_USER es correcto"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è VPS_SSH_PASSWORD no est√° configurado"
            echo "   No se puede probar la conexi√≥n SSH"
          fi

