name: Verify SSH Password Configuration

on:
  workflow_dispatch:

jobs:
  verify-password:
    name: Verify SSH Password in GitHub Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check SSH Password Secret
        run: |
          echo "=========================================="
          echo "  üîê Verificaci√≥n de Contrase√±a SSH"
          echo "=========================================="
          echo ""
          
          # Verificar si el secret existe
          if [ -z "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "‚ùå VPS_SSH_PASSWORD NO est√° configurado en GitHub Secrets"
            echo ""
            echo "üí° Pasos para configurarlo:"
            echo "   1. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: VPS_SSH_PASSWORD"
            echo "   4. Value: Aar-Beto-2026 (sin espacios, sin comillas)"
            echo "   5. Click 'Add secret'"
            exit 1
          fi
          
          echo "‚úÖ VPS_SSH_PASSWORD est√° configurado en GitHub Secrets"
          echo ""
          
          # Obtener informaci√≥n sobre la contrase√±a (sin mostrarla)
          PASSWORD="${{ secrets.VPS_SSH_PASSWORD }}"
          
          # Longitud
          PASSWORD_LENGTH=$(echo -n "$PASSWORD" | wc -c)
          echo "üìè Longitud de la contrase√±a: $PASSWORD_LENGTH caracteres"
          
          # Primer car√°cter
          FIRST_CHAR=$(echo -n "$PASSWORD" | head -c 1)
          echo "üî§ Primer car√°cter: $FIRST_CHAR***"
          
          # √öltimo car√°cter
          LAST_CHAR=$(echo -n "$PASSWORD" | tail -c 1)
          echo "üî§ √öltimo car√°cter: ***$LAST_CHAR"
          
          # Caracteres especiales presentes
          SPECIAL_CHARS=$(echo -n "$PASSWORD" | grep -o '[^a-zA-Z0-9]' | sort -u | tr -d '\n' || echo 'ninguno')
          echo "üî£ Caracteres especiales: $SPECIAL_CHARS"
          
          # Verificar si tiene espacios
          if echo "$PASSWORD" | grep -q '^ ' || echo "$PASSWORD" | grep -q ' $'; then
            echo "‚ö†Ô∏è ADVERTENCIA: La contrase√±a tiene espacios al inicio o final"
            echo "   Esto puede causar problemas. Elimina los espacios."
          else
            echo "‚úÖ No hay espacios al inicio o final"
          fi
          
          # Verificar longitud esperada
          EXPECTED_LENGTH=13  # "Aar-Beto-2026" tiene 13 caracteres
          if [ "$PASSWORD_LENGTH" -eq "$EXPECTED_LENGTH" ]; then
            echo "‚úÖ Longitud coincide con la esperada ($EXPECTED_LENGTH caracteres)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: La longitud ($PASSWORD_LENGTH) no coincide con la esperada ($EXPECTED_LENGTH)"
            echo "   Verifica que la contrase√±a sea exactamente: Aar-Beto-2026"
          fi
          
          # Verificar primer car√°cter esperado
          if [ "$FIRST_CHAR" == "A" ]; then
            echo "‚úÖ Primer car√°cter correcto (A)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: Primer car√°cter es '$FIRST_CHAR', esperado 'A'"
          fi
          
          # Verificar √∫ltimo car√°cter esperado
          if [ "$LAST_CHAR" == "6" ]; then
            echo "‚úÖ √öltimo car√°cter correcto (6)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: √öltimo car√°cter es '$LAST_CHAR', esperado '6'"
          fi
          
          echo ""
          echo "=========================================="
          echo "  üìã RESUMEN"
          echo "=========================================="
          echo ""
          
          # Verificar si todo est√° correcto
          ISSUES=0
          
          if [ "$PASSWORD_LENGTH" -ne "$EXPECTED_LENGTH" ]; then
            echo "‚ùå Longitud incorrecta"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ "$FIRST_CHAR" != "A" ]; then
            echo "‚ùå Primer car√°cter incorrecto"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ "$LAST_CHAR" != "6" ]; then
            echo "‚ùå √öltimo car√°cter incorrecto"
            ISSUES=$((ISSUES + 1))
          fi
          
          if echo "$PASSWORD" | grep -q '^ ' || echo "$PASSWORD" | grep -q ' $'; then
            echo "‚ùå Tiene espacios extra"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ $ISSUES -eq 0 ]; then
            echo "‚úÖ La contrase√±a parece estar configurada correctamente"
            echo ""
            echo "Pr√≥ximos pasos:"
            echo "   1. Ejecuta 'Test SSH Connection' para verificar que funciona"
            echo "   2. Si funciona, ejecuta el deployment completo"
          else
            echo "‚ùå Se encontraron $ISSUES problema(s) con la contrase√±a"
            echo ""
            echo "üí° Soluci√≥n:"
            echo "   1. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Busca VPS_SSH_PASSWORD"
            echo "   3. Click 'Update'"
            echo "   4. Pega exactamente: Aar-Beto-2026"
            echo "      (sin espacios, sin comillas, exactamente como est√°)"
            echo "   5. Click 'Update secret'"
            exit 1
          fi
          
          echo ""
          echo "=========================================="

      - name: Test SSH Connection (if password looks correct)
        if: success()
        run: |
          echo "üß™ Probando conexi√≥n SSH con la contrase√±a configurada..."
          echo ""
          
          # Instalar herramientas SSH
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass
          
          # Deshabilitar agente SSH
          unset SSH_AUTH_SOCK
          unset SSH_AGENT_PID
          export SSH_AUTH_SOCK=""
          export SSH_AGENT_PID=""
          rm -f ~/.ssh/id_* 2>/dev/null || true
          rm -f ~/.ssh/known_hosts 2>/dev/null || true
          
          # Probar conexi√≥n usando sshpass -p directamente (m√°s confiable)
          echo "üîç Intentando conexi√≥n SSH..."
          echo ""
          echo "üìã Informaci√≥n de debugging:"
          echo "   Host: 72.60.63.240"
          echo "   User: root"
          echo "   Password length: $(echo -n '${{ secrets.VPS_SSH_PASSWORD }}' | wc -c) characters"
          echo ""
          
          # Guardar output completo en archivo
          sshpass -p '${{ secrets.VPS_SSH_PASSWORD }}' ssh -vvv \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o PreferredAuthentications=password \
              -o PubkeyAuthentication=no \
              -o PasswordAuthentication=yes \
              -o BatchMode=yes \
              -o NumberOfPasswordPrompts=1 \
              -o IdentitiesOnly=yes \
              -o IdentityFile=/dev/null \
              -o KbdInteractiveAuthentication=no \
              -o ChallengeResponseAuthentication=no \
              -o GSSAPIAuthentication=no \
              -o HostbasedAuthentication=no \
              root@72.60.63.240 \
              "echo '‚úÖ Conexi√≥n SSH exitosa' && hostname" > /tmp/ssh-full-output.log 2>&1
          
          SSH_EXIT_CODE=$?
          
          # Mostrar output completo para debugging
          echo "üìã Output completo de SSH (√∫ltimas 50 l√≠neas):"
          tail -50 /tmp/ssh-full-output.log
          
          if [ $SSH_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ ¬°La contrase√±a funciona correctamente!"
            echo ""
            echo "üéâ Todo est√° listo para el deployment"
            echo ""
            echo "Pr√≥ximos pasos:"
            echo "   1. Ejecuta 'Test SSH Connection' para verificar completamente"
            echo "   2. Si funciona, ejecuta el deployment completo"
          else
            echo ""
            echo "‚ùå La conexi√≥n SSH fall√≥ (exit code: $SSH_EXIT_CODE)"
            echo ""
            echo "üîç An√°lisis detallado del error:"
            
            # Analizar el tipo de error desde el archivo
            if grep -qi "Permission denied" /tmp/ssh-full-output.log; then
              echo "   ‚ùå El servidor rechaz√≥ la autenticaci√≥n"
              echo "   üí° La contrase√±a en GitHub Secrets es INCORRECTA"
              echo ""
              echo "   üìã Informaci√≥n de la contrase√±a actual:"
              PASSWORD_LEN=$(echo -n '${{ secrets.VPS_SSH_PASSWORD }}' | wc -c)
              FIRST_CHAR=$(echo -n '${{ secrets.VPS_SSH_PASSWORD }}' | head -c 1)
              LAST_CHAR=$(echo -n '${{ secrets.VPS_SSH_PASSWORD }}' | tail -c 1)
              echo "      Longitud: $PASSWORD_LEN caracteres (esperada: 13)"
              echo "      Primer car√°cter: '$FIRST_CHAR' (esperado: 'A')"
              echo "      √öltimo car√°cter: '$LAST_CHAR' (esperado: '6')"
              echo ""
              echo "   üîß Soluci√≥n CR√çTICA:"
              echo "      1. Con√©ctate manualmente: ssh root@72.60.63.240"
              echo "      2. Usa la contrase√±a EXACTA que funciona: Aar-Beto-2026"
              echo "      3. Copia esa contrase√±a EXACTA (sin espacios, sin comillas)"
              echo "      4. Ve a GitHub Secrets y actualiza VPS_SSH_PASSWORD"
              echo "      5. IMPORTANTE: Escribe la contrase√±a manualmente si copiar/pegar no funciona"
              echo "      6. Ejecuta este workflow de nuevo"
            elif grep -qi "Connection refused\|Connection timed out" /tmp/ssh-full-output.log; then
              echo "   ‚ùå No se pudo conectar al servidor"
              echo "   üí° Verifica que el servidor est√© accesible"
              echo "   üí° Verifica que VPS_HOST sea correcto: 72.60.63.240"
            elif grep -qi "Host key verification failed" /tmp/ssh-full-output.log; then
              echo "   ‚ùå Problema con la verificaci√≥n del host key"
              echo "   üí° Esto deber√≠a resolverse autom√°ticamente"
            else
              echo "   ‚ùå Error desconocido"
              echo "   üí° Revisa los logs completos arriba para m√°s detalles"
              echo ""
              echo "   üìã L√≠neas clave del error:"
              grep -i "error\|failed\|denied" /tmp/ssh-full-output.log | tail -10 || echo "   (No se encontraron l√≠neas de error espec√≠ficas)"
            fi
            echo ""
            echo "üí° Troubleshooting adicional:"
            echo "   1. Verifica la contrase√±a manualmente: ssh root@72.60.63.240"
            echo "   2. Usa la MISMA contrase√±a que funciona manualmente"
            echo "   3. Actualiza VPS_SSH_PASSWORD en GitHub Secrets"
            echo "   4. Verifica que no haya espacios extra o caracteres ocultos"
            exit 1
          fi

