name: Verify SSH Password Configuration

on:
  workflow_dispatch:

jobs:
  verify-password:
    name: Verify SSH Password in GitHub Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check SSH Password Secret
        run: |
          echo "=========================================="
          echo "  üîê Verificaci√≥n de Contrase√±a SSH"
          echo "=========================================="
          echo ""
          
          # Verificar si el secret existe
          if [ -z "${{ secrets.VPS_SSH_PASSWORD }}" ]; then
            echo "‚ùå VPS_SSH_PASSWORD NO est√° configurado en GitHub Secrets"
            echo ""
            echo "üí° Pasos para configurarlo:"
            echo "   1. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: VPS_SSH_PASSWORD"
            echo "   4. Value: Aar-Beto-2026 (sin espacios, sin comillas)"
            echo "   5. Click 'Add secret'"
            exit 1
          fi
          
          echo "‚úÖ VPS_SSH_PASSWORD est√° configurado en GitHub Secrets"
          echo ""
          
          # Obtener informaci√≥n sobre la contrase√±a (sin mostrarla)
          PASSWORD="${{ secrets.VPS_SSH_PASSWORD }}"
          
          # Longitud
          PASSWORD_LENGTH=$(echo -n "$PASSWORD" | wc -c)
          echo "üìè Longitud de la contrase√±a: $PASSWORD_LENGTH caracteres"
          
          # Primer car√°cter
          FIRST_CHAR=$(echo -n "$PASSWORD" | head -c 1)
          echo "üî§ Primer car√°cter: $FIRST_CHAR***"
          
          # √öltimo car√°cter
          LAST_CHAR=$(echo -n "$PASSWORD" | tail -c 1)
          echo "üî§ √öltimo car√°cter: ***$LAST_CHAR"
          
          # Caracteres especiales presentes
          SPECIAL_CHARS=$(echo -n "$PASSWORD" | grep -o '[^a-zA-Z0-9]' | sort -u | tr -d '\n' || echo 'ninguno')
          echo "üî£ Caracteres especiales: $SPECIAL_CHARS"
          
          # Verificar si tiene espacios
          if echo "$PASSWORD" | grep -q '^ ' || echo "$PASSWORD" | grep -q ' $'; then
            echo "‚ö†Ô∏è ADVERTENCIA: La contrase√±a tiene espacios al inicio o final"
            echo "   Esto puede causar problemas. Elimina los espacios."
          else
            echo "‚úÖ No hay espacios al inicio o final"
          fi
          
          # Verificar longitud esperada
          EXPECTED_LENGTH=13  # "Aar-Beto-2026" tiene 13 caracteres
          if [ "$PASSWORD_LENGTH" -eq "$EXPECTED_LENGTH" ]; then
            echo "‚úÖ Longitud coincide con la esperada ($EXPECTED_LENGTH caracteres)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: La longitud ($PASSWORD_LENGTH) no coincide con la esperada ($EXPECTED_LENGTH)"
            echo "   Verifica que la contrase√±a sea exactamente: Aar-Beto-2026"
          fi
          
          # Verificar primer car√°cter esperado
          if [ "$FIRST_CHAR" == "A" ]; then
            echo "‚úÖ Primer car√°cter correcto (A)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: Primer car√°cter es '$FIRST_CHAR', esperado 'A'"
          fi
          
          # Verificar √∫ltimo car√°cter esperado
          if [ "$LAST_CHAR" == "6" ]; then
            echo "‚úÖ √öltimo car√°cter correcto (6)"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: √öltimo car√°cter es '$LAST_CHAR', esperado '6'"
          fi
          
          echo ""
          echo "=========================================="
          echo "  üìã RESUMEN"
          echo "=========================================="
          echo ""
          
          # Verificar si todo est√° correcto
          ISSUES=0
          
          if [ "$PASSWORD_LENGTH" -ne "$EXPECTED_LENGTH" ]; then
            echo "‚ùå Longitud incorrecta"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ "$FIRST_CHAR" != "A" ]; then
            echo "‚ùå Primer car√°cter incorrecto"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ "$LAST_CHAR" != "6" ]; then
            echo "‚ùå √öltimo car√°cter incorrecto"
            ISSUES=$((ISSUES + 1))
          fi
          
          if echo "$PASSWORD" | grep -q '^ ' || echo "$PASSWORD" | grep -q ' $'; then
            echo "‚ùå Tiene espacios extra"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ $ISSUES -eq 0 ]; then
            echo "‚úÖ La contrase√±a parece estar configurada correctamente"
            echo ""
            echo "Pr√≥ximos pasos:"
            echo "   1. Ejecuta 'Test SSH Connection' para verificar que funciona"
            echo "   2. Si funciona, ejecuta el deployment completo"
          else
            echo "‚ùå Se encontraron $ISSUES problema(s) con la contrase√±a"
            echo ""
            echo "üí° Soluci√≥n:"
            echo "   1. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Busca VPS_SSH_PASSWORD"
            echo "   3. Click 'Update'"
            echo "   4. Pega exactamente: Aar-Beto-2026"
            echo "      (sin espacios, sin comillas, exactamente como est√°)"
            echo "   5. Click 'Update secret'"
            exit 1
          fi
          
          echo ""
          echo "=========================================="

      - name: Test SSH Connection (if password looks correct)
        if: success()
        run: |
          echo "üß™ Probando conexi√≥n SSH con la contrase√±a configurada..."
          echo ""
          
          # Instalar herramientas SSH
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass
          
          # Configurar contrase√±a
          export SSHPASS="${{ secrets.VPS_SSH_PASSWORD }}"
          
          # Deshabilitar agente SSH
          unset SSH_AUTH_SOCK
          unset SSH_AGENT_PID
          export SSH_AUTH_SOCK=""
          export SSH_AGENT_PID=""
          rm -f ~/.ssh/id_* 2>/dev/null || true
          rm -f ~/.ssh/known_hosts 2>/dev/null || true
          
          # Probar conexi√≥n
          if sshpass -e ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o PreferredAuthentications=password \
              -o PubkeyAuthentication=no \
              -o PasswordAuthentication=yes \
              -o BatchMode=yes \
              -o IdentitiesOnly=yes \
              -o IdentityFile=/dev/null \
              root@72.60.63.240 \
              "echo '‚úÖ Conexi√≥n SSH exitosa' && hostname" 2>&1; then
            echo ""
            echo "‚úÖ ¬°La contrase√±a funciona correctamente!"
            echo ""
            echo "üéâ Todo est√° listo para el deployment"
          else
            echo ""
            echo "‚ùå La conexi√≥n SSH fall√≥"
            echo ""
            echo "üí° Posibles causas:"
            echo "   1. La contrase√±a en GitHub Secrets es incorrecta"
            echo "   2. Hay espacios extra o caracteres mal codificados"
            echo "   3. El servidor tiene restricciones adicionales"
            echo ""
            echo "üîß Soluci√≥n:"
            echo "   1. Verifica la contrase√±a manualmente: ssh root@72.60.63.240"
            echo "   2. Usa la MISMA contrase√±a que funciona manualmente"
            echo "   3. Actualiza VPS_SSH_PASSWORD en GitHub Secrets"
            exit 1
          fi

